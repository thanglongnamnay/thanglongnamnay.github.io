"use strict";const keyPosition={last:[55,13,27,41],first:[0,14,28,42]};let thinkTime=250,fastMode=!1;const $=s=>document.querySelectorAll(s),trunc=s=>(s+56)%56,randomDiceRoll=()=>Math.floor(6*Math.random())+1,log=s=>console.log(`Something went wrong with '${s}'`);class Box{constructor(s,i=-1){this._position=s,this._team=i,this._sclickFunc=[],this._DOM=this.getDOM(),this._class=this._DOM.className,this._pawn=-7===s?4:0,this._maxPawn=-7===s?4:1}get DOM(){return this._DOM}get class(){return this._class}get sclickFunc(){return this._sclickFunc}get position(){return this._position}get team(){return this._team}get pawn(){return this._pawn}get maxPawn(){return this._maxPawn}addPawn(s){return!(this.pawn===this.maxPawn||s<0||s>=4)&&(this._team=s,this.class.indexOf("pos")>=0||this.class.indexOf("chuong")>=0?(this.DOM.style.backgroundImage="url(images/horse"+this.team+".svg)",this._pawn++,!0):this.class.indexOf("home")>=0?(this.DOM.innerHTML+='<img src="images/horse'+this.team+'.svg">',this._pawn++,!0):(log("moveto"),!1))}removePawn(){return 0!==this.pawn&&(this.position>-7?(this.DOM.style.backgroundImage="none",this._pawn--,keyPosition.first.indexOf(this.position)>=0&&(this.DOM.style.backgroundImage=`url(images/arrow${this.position/14}.svg)`),!0):this.class.indexOf("home")>=0?(this.DOM.removeChild(this.DOM.firstChild),this._pawn--,!0):(log("moveto"),!1))}clickState(s){this.DOM.onclick=s?()=>this.DOM.dispatchEvent(new CustomEvent("sclick")):{}}addSclick(s){this._sclickFunc.push(s),this.DOM.addEventListener("sclick",this.sclickFunc[this.sclickFunc.length-1])}removeSclick(){if(this.sclickFunc)for(let s of this.sclickFunc)this._DOM.removeEventListener("sclick",s);this._sclickFunc=[]}sclick(){this.DOM.dispatchEvent(new CustomEvent("sclick"))}changeLight(s){return 0===s?(this.DOM.style.filter="brightness(100%)",!0):1===s?(this.DOM.style.filter="brightness(85%)",!0):2===s?(this.DOM.style.filter="brightness(70%)",!0):(log("changeLight"),!1)}getDOM(){return-8===this.position?$(".dice")[0]:-7===this.position?$(".home"+this.team)[0]:this.position<0?$(".chuong"+this.team+-this.position)[0]:this.position>=0&&this.position<56?$(".pos"+this.position)[0]:(log("getDom"),null)}}let boxes=[],pawnPos=[[-7,-7,-7,-7],[-7,-7,-7,-7],[-7,-7,-7,-7],[-7,-7,-7,-7]],dices=[],currentTeam=0,players=1;function play(s,i){if(!fullCheck(s))return nextTurn(),!1;diceOnSclick(!1);for(let e of pawnPos[s])emphasize(s,e,dices).length>0&&getBox(e,s).addSclick(()=>{resetDisplay();let t=emphasize(s,e,dices);for(let o of t)getBox(o,s).addSclick(()=>{check(s,e,6)===o?dices.splice(0,1):dices.pop(),--i,move(s,e,o),resetDisplay(),clearSclick(),0===i?nextTurn():play(s,i)})});return s>=players&&think(s,dices,pawnPos),!0}function think(s,i,e){let t=i[i.length-1],o=[];for(let c of e[s]){let e=[check(s,c,t)];t!==i[0]&&e.push(check(s,c,6)),1===t&&c>=0&&e.push(check(s,c,nearestLastDice(c)));for(let s of e)null!==s&&o.push([c,s])}let c=function(s,i){for(let e of i)e[1]<0&&e[1]>-7?e.push(80*-e[1]-79):e[1]===keyPosition.last[s]?e.push(120):e[1]===keyPosition.first[s]?e.push(60):exist(e[1])?e.push(40+3*trunc(e[1]-e[1])):e[1]==keyPosition.last[s]-1?e.push(0):e.push(trunc(e[1]-e[0]));let e=0;for(;e<i.length&&i[e][2]<6;)++e;e===i.length&&i.push([-8,-8,1]);return i}(s,o),n=[];for(let s of c)n.push(s[2]);let l=o[function(s){let i=s.slice(0),e=0,t=[];i.sort(function(s,i){return s-i});for(let s of i)e+=s,t.push(e);let o=Math.round(Math.random()*e),c=0;for(;o>t[c];)c++;return s.indexOf(i[c])}(n)];setTimeout(()=>{getBox(l[0],s).sclick(),l[1]>-8&&setTimeout(()=>{getBox(l[1],s).sclick()},thinkTime)},thinkTime)}function exist(s,i=4){if(4===i){for(let i=0;i<4;++i)if(pawnPos[i].indexOf(s)>=0)return!0;return!1}return pawnPos[i].indexOf(s)>=0}function nextTurn(){if(resetDisplay(),dices=[],win(currentTeam)){diceOnSclick(!1),clearSclick();let s=confirm(`Team ${currentTeam+1} win, vant to play again?`);clearSclick(),1==s?location.reload():alert("I'm out!")}else setTimeout(()=>{clearSclick(),moveDice(currentTeam=(currentTeam+1)%4),$(".ketqua")[0].innerHTML="",rollDice()},thinkTime)}function diceOnSclick(s){getBox(-8).removeSclick(),s?getBox(-8).addSclick(rollDice):getBox(-8).addSclick(nextTurn)}function win(s){for(let i of pawnPos[s])if(-3!=i&&-4!=i&&-5!=i&&-6!=i)return!1;return!0}function emphasize(s,i,e){let t=e[e.length-1],o=[check(s,i,t)],c=[];t!==e[0]&&o.push(check(s,i,6)),1===t&&i>=0&&o.push(check(s,i,nearestLastDice(i)));for(let e of o)null!==e&&(getBox(i,s).changeLight(2),getBox(e,s).changeLight(1),c.push(e));return c}function nearestLastDice(s){return s<0?-1:s%14==13?14:13-s%14}function clearSclick(){for(let s of boxes)s.removeSclick()}function clickListener(s){for(let i of boxes)i.clickState(s)}function diceSound(){const s=Math.floor(6*Math.random()+1);return new Audio("/CoCaNgua/sound/xx"+s+".wav")}function rollDice(){diceOnSclick(!1),clickListener(currentTeam<players),showDices(currentTeam,dices);let s=randomDiceRoll(),i=diceSound();function e(){dices.push(s),6===s?rollDice():(showDices(currentTeam,dices),play(currentTeam,dices.length))}fastMode?e():(i.play().catch(()=>{}),i.onloadedmetadata=()=>setTimeout(e,1e3*i.duration))}function showDices(s,i){let e=$(".ketqua")[0];e.innerHTML="";for(let s of i)e.innerHTML+=s+" "}function getBox(s,i){if(-8===s)return boxes[boxes.length-1];if(s<0){for(let e of boxes)if(e.position===s&&e.team===i)return e}else for(let i of boxes)if(i.position===s)return i;return log("getBox"),boxes[0]}function getPositions(){let s=[[],[],[],[]];for(let i of boxes)if(i.pawn>0)for(let e=0;e<i.pawn;++e)s[i.team].push(i.position);return s}function fullCheck(s){for(let i of dices)for(let e=0;e<4;++e)if(null!==check(s,pawnPos[s][e],i))return!0;return!1}function check(s,i,e){let t=getPositions();if(-7===i)return 6!==e?null:t[s].indexOf(keyPosition.first[s])>=0?null:keyPosition.first[s];if(i<0)return-e!=i-1||exist(i-1,s)?null:-e;if(i===keyPosition.last[s]){for(let i=1;i<=e;++i)if(t[s].indexOf(-i)>=0)return null;return-e}if(i>=0&&i<56){let c=function(s,i,e){let t=keyPosition.last[s];for(let c=0;c<4;++c)for(let n=0;n<4;++n){if(e[c][n]<0)continue;let l=o(s,e[c][n],i);l<o(s,t,i)&&l>0&&(t=e[c][n])}return{position:t,distant:o(s,t,i)}}(s,i,t);return c.distant<e?null:c.distant===e&&t[s].indexOf(trunc(i+e))>=0?null:trunc(i+e)}return log("check"),null;function o(s,i,e){return trunc(i-keyPosition.first[s]+56)-trunc(e-keyPosition.first[s]+56)}}function move(s,i,e){new Audio("sound/dc1.wav").play().catch(console.log),e>=0&&kill(e),getBox(i,s).removePawn(),getBox(e,s).addPawn(s);for(let t=0;t<4;++t)if(pawnPos[s][t]===getBox(i,s).position)return void(pawnPos[s][t]=getBox(e,s).position)}function kill(s){let i=getBox(s);if(1===i.pawn){new Audio("sound/ngoec.wav").play().catch(s=>console.log(s)),move(i.team,s,-7)}}function setup(){paint(),moveDice(0);const s=$("div");for(let i=3;i<=87;++i)s[i].style.gridArea=s[i].className,(s[i].className.indexOf("chuong0")>=0||s[i].className.indexOf("chuong2")>=0||s[i].className.indexOf("55")>=0||s[i].className.indexOf("27")>=0)&&(s[i].style.backgroundSize="auto 100%");for(let s=0;s<4;++s)boxes.push(new Box(-7,s));for(let s=4;s<60;++s)boxes.push(new Box(s-4));for(let s=0;s<4;++s)for(let i=0;i<6;++i)boxes.push(new Box(-i-1,s));boxes.push(new Box(-8)),diceOnSclick(!0),$(".nowhere")[0].onclick=()=>location.reload(),document.onkeyup=s=>{"Enter"==s.key?$(".dice")[0].click():"Escape"==s.key&&nextTurn()}}function paint(){const s=[["rgb(100,100,225)","rgb(160,160,225)"],["rgb(100,225,100)","rgb(160,225,160)"],["rgb(225,100,100)","rgb(255,160,160)"],["rgb(225,225,0)","rgb(225,225,120)"]];for(let i=0;i<4;i++){let e=$(".pos"+14*i)[0];e.style.backgroundColor=s[i][0],e.onmouseenter=()=>e.style.backgroundColor=s[i][1],e.onmouseleave=()=>e.style.backgroundColor=s[i][0];for(let s=0;s<4;s++){let i=$(".home"+s)[0];i.onmouseenter=()=>i.style.filter="saturate(130%)",i.onmouseleave=()=>i.style.filter="saturate(100%)"}for(let e=1;e<=6;e++){let t=$(".chuong"+i+e)[0];t.style.backgroundColor=s[i][0],t.onmouseenter=()=>t.style.backgroundColor=s[i][1],t.onmouseleave=()=>t.style.backgroundColor=s[i][0]}}}function resetDisplay(){for(let s of boxes)s.changeLight(0)}function moveDice(s){if(s>=4||s<0)return log("moveDice"),!1;let i=$(".ketqua")[0],e=$(".controls")[0];switch(s){case 0:return e.style.top="3%",e.style.left="5%",i.style.direction="ltr",!0;case 1:return e.style.top="65%",e.style.left="5%",i.style.direction="ltr",!0;case 2:return e.style.top="65%",e.style.left="75%",i.style.direction="rtl",!0;default:return e.style.top="3%",e.style.left="75%",i.style.direction="rtl",!0}}function drawHomePage(){$(".table-container")[0].innerHTML='<div class="openpage">\n    \t<p class="game-title fontlarge">CỜ CÁ NGỰA</p>\n    \t<div class="gamemode fontmedium">\n    \t\t<a onclick="drawBoard(1)">⏵ 1 người đấu 3 máy</a> <br>\n    \t\t<a onclick="drawBoard(0)">⏵ Xem 4 máy đấu với nhau</a> <br>\n            <label for="fast-mode">Quick mode: Ai chỉ thích quan tâm đến kết quả thì chọn cái này</label>\n            <input type="checkbox" id="fast-mode">\n    \t</div>\n    </div>'}function drawBoard(s=0){fastMode=$("#fast-mode")[0].checked,console.log(fastMode),thinkTime=fastMode?1:250,$(".table-container")[0].innerHTML='<div class="table"><div class="home0"><img src="images/horse0.svg"><img src="images/horse0.svg"><img src="images/horse0.svg"><img src="images/horse0.svg"></div><div class="home3"><img src="images/horse3.svg"><img src="images/horse3.svg"><img src="images/horse3.svg"><img src="images/horse3.svg"></div><div class="home1"><img src="images/horse1.svg"><img src="images/horse1.svg"><img src="images/horse1.svg"><img src="images/horse1.svg"></div><div class="home2"><img src="images/horse2.svg"><img src="images/horse2.svg"><img src="images/horse2.svg"><img src="images/horse2.svg"></div><div class="pos0" style="background-image: url(images/arrow0.svg)"></div><div class="pos1"></div><div class="pos2"></div><div class="pos3"></div><div class="pos4"></div><div class="pos5"></div><div class="pos6"></div><div class="pos7"></div><div class="pos8"></div><div class="pos9"></div><div class="pos10"></div><div class="pos11"></div><div class="pos12"></div><div class="pos13"></div><div class="pos14" style="background-image: url(images/arrow1.svg)"></div><div class="pos15"></div><div class="pos16"></div><div class="pos17"></div><div class="pos18"></div><div class="pos19"></div><div class="pos20"></div><div class="pos21"></div><div class="pos22"></div><div class="pos23"></div><div class="pos24"></div><div class="pos25"></div><div class="pos26"></div><div class="pos27"></div><div class="pos28" style="background-image: url(images/arrow2.svg)"></div><div class="pos29"></div><div class="pos30"></div><div class="pos31"></div><div class="pos32"></div><div class="pos33"></div><div class="pos34"></div><div class="pos35"></div><div class="pos36"></div><div class="pos37"></div><div class="pos38"></div><div class="pos39"></div><div class="pos40"></div><div class="pos41"></div><div class="pos42" style="background-image: url(images/arrow3.svg)"></div><div class="pos43"></div><div class="pos44"></div><div class="pos45"></div><div class="pos46"></div><div class="pos47"></div><div class="pos48"></div><div class="pos49"></div><div class="pos50"></div><div class="pos51"></div><div class="pos52"></div><div class="pos53"></div><div class="pos54"></div><div class="pos55"></div><div class="chuong11"></div><div class="chuong12"></div><div class="chuong13"></div><div class="chuong14"></div><div class="chuong15"></div><div class="chuong16"></div><div class="chuong31"></div><div class="chuong32"></div><div class="chuong33"></div><div class="chuong34"></div><div class="chuong35"></div><div class="chuong36"></div><div class="chuong01"></div><div class="chuong02"></div><div class="chuong03"></div><div class="chuong04"></div><div class="chuong05"></div><div class="chuong06"></div><div class="chuong21"></div><div class="chuong22"></div><div class="chuong23"></div><div class="chuong24"></div><div class="chuong25"></div><div class="chuong26"></div><div class="nowhere"></div></div><div class="controls" style="position: fixed;"><img src="images/dice.svg" alt="Xóc đĩa" class="dice fontmedium"><div class="ketqua fontmedium"></div></div>',players=s,setup(),clickListener(!0),0===s&&(clickListener(!1),rollDice())}drawHomePage();